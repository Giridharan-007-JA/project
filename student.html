<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Dashboard - Alumni Connection</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    /* CRITICAL CHAT INPUT VISIBILITY FIX */
    .message-input {
      padding: 20px !important;
      border-top: 1px solid #eee !important;
      display: flex !important;
      gap: 10px !important;
      background: white !important;
    }

    .message-input input {
      color: #1e293b !important;
      -webkit-text-fill-color: #1e293b !important;
      background: #ffffff !important;
      font-size: 1rem !important;
      line-height: 1.5 !important;
      opacity: 1 !important;
      padding: 12px 16px !important;
      border: 2px solid #cbd5e0 !important;
      border-radius: 8px !important;
      caret-color: #60a5fa !important;
      font-family: 'Inter', sans-serif !important;
      flex: 1 !important;
    }

    .message-input input::selection {
      background: rgba(96, 165, 250, 0.3) !important;
      color: #1e293b !important;
    }
    
    .message-input input:focus {
      background: #ffffff !important;
      color: #1e293b !important;
      -webkit-text-fill-color: #1e293b !important;
      border-color: #60a5fa !important;
      border-width: 2px !important;
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1) !important;
      outline: none !important;
    }
    
    .message-input input::placeholder {
      color: #94a3b8 !important;
      -webkit-text-fill-color: #94a3b8 !important;
      opacity: 1 !important;
    }
    
    .message-input input:disabled {
      background: #f1f5f9 !important;
      color: #94a3b8 !important;
      -webkit-text-fill-color: #94a3b8 !important;
      cursor: not-allowed !important;
      opacity: 0.6 !important;
      border-color: #cbd5e0 !important;
    }
    
    .message-content {
      max-width: 70% !important;
      padding: 12px !important;
      border-radius: 12px !important;
      position: relative !important;
      word-wrap: break-word !important;
      word-break: break-word !important;
    }

    .message-content p {
      color: #1e293b !important;
      -webkit-text-fill-color: #1e293b !important;
      display: block !important;
      visibility: visible !important;
      margin: 0 !important;
      white-space: normal !important;
      word-wrap: break-word !important;
      font-size: 1rem !important;
    }
    
    .message.sent .message-content {
      background: #007bff !important;
      color: white !important;
      -webkit-text-fill-color: white !important;
    }

    .message.sent .message-content p {
      color: white !important;
      -webkit-text-fill-color: white !important;
    }
    
    .message.received .message-content {
      background: #f0f2f5 !important;
      color: #1e293b !important;
    }

    .message.received .message-content p {
      color: #1e293b !important;
      -webkit-text-fill-color: #1e293b !important;
    }

    /* Profile header with smaller edit button in corner */
    .profile-header {
      position: relative;
      padding-bottom: 20px;
      margin-bottom: 30px;
      border-bottom: 2px solid #f0f0f0;
    }

    .profile-info-wrapper {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .edit-profile-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: linear-gradient(135deg, #60a5fa, #818cf8);
      color: white;
      border: none;
      padding: 6px 6px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 6px rgba(96, 165, 250, 0.3);
      z-index: 10;
      line-height: 1;
    }

    .edit-profile-btn:hover {
      background: linear-gradient(135deg, #3b82f6, #6366f1);
      transform: scale(1.15);
      box-shadow: 0 3px 10px rgba(96, 165, 250, 0.4);
    }

    .edit-profile-btn i {
      font-size: 0.9rem;
    }

    /* Edit Profile Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      animation: fadeIn 0.3s ease;
    }

    .modal.active {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .modal-header h3 {
      font-size: 1.5rem;
      color: #1e293b;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #64748b;
      transition: color 0.3s ease;
    }

    .close-modal:hover {
      color: #1e293b;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #475569;
      font-weight: 500;
      font-size: 0.9rem;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #cbd5e0;
      border-radius: 10px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #60a5fa;
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .skills-input-wrapper {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .skills-input-wrapper input {
      flex: 1;
    }

    .add-skill-btn {
      background: #60a5fa;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .add-skill-btn:hover {
      background: #3b82f6;
    }

    .skills-list-edit {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .skill-tag-edit {
      background: #e0f2fe;
      color: #0369a1;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .remove-skill {
      background: none;
      border: none;
      color: #0369a1;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 0;
      display: flex;
      align-items: center;
    }

    .remove-skill:hover {
      color: #dc2626;
    }

    .save-profile-btn {
      width: 100%;
      background: linear-gradient(135deg, #60a5fa, #818cf8);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }

    .save-profile-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
    }
  </style>
</head>
<body class="dashboard-body">
  <!-- Sidebar Navigation -->
  <nav class="sidebar">
    <div class="sidebar-header">
      <div class="avatar" id="userAvatar">S</div>
      <h3 id="welcomeUsername">Student</h3>
      <p class="status-text">Active</p>
    </div>
    <ul class="nav-links">
      <li class="active" data-page="profile">
        <i class="fas fa-user"></i>
        <span>My Profile</span>
      </li>
      <li data-page="alumni">
        <i class="fas fa-users"></i>
        <span>Alumni Directory</span>
      </li>
      <li data-page="chat">
        <i class="fas fa-comments"></i>
        <span>Messages</span>
        <span class="badge" id="unreadCount" style="display: none;">0</span>
      </li>
      <li data-page="events">
        <i class="fas fa-calendar"></i>
        <span>Events</span>
      </li>
      <li data-page="jobs">
        <i class="fas fa-briefcase"></i>
        <span>Job Board</span>
      </li>
      <li id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i>
        <span>Logout</span>
      </li>
    </ul>
  </nav>

  <!-- Main Content Area -->
  <main class="main-content">
    <!-- Profile Section -->
    <section id="profile" class="content-section active">
      <h2>My Profile</h2>
      <div class="profile-card">
        <div class="profile-header">
          <div class="profile-info-wrapper">
            <div class="avatar large-profile-pic" id="profileAvatar">S</div>
            <div>
              <h3 id="profileName">Student Name</h3>
              <p class="alumni-position" id="profileDepartment">Computer Science</p>
            </div>
          </div>
          <button class="edit-profile-btn" id="editProfileBtn" title="Edit Profile">
            <i class="fas fa-edit"></i>
          </button>
        </div>

        <div class="info-group">
          <label>Email</label>
          <p id="email">student@example.com</p>
        </div>

        <div class="info-group">
          <label>Year of Study</label>
          <p id="yearOfStudy">3rd Year</p>
        </div>

        <div class="info-group">
          <label>Department</label>
          <p id="department">Computer Science</p>
        </div>

        <div class="info-group">
          <label>Student ID</label>
          <p id="studentId">CS2021001</p>
        </div>

        <div class="info-group">
          <label>Skills</label>
          <div class="skills-list" id="skillsList">
            <span class="skill-tag">JavaScript</span>
            <span class="skill-tag">Python</span>
            <span class="skill-tag">React</span>
          </div>
        </div>

        <div class="info-group">
          <label>Achievements</label>
          <ul class="achievements-list" id="achievementsList">
            <li>Hackathon Winner 2023</li>
            <li>Dean's List</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Alumni Directory Section -->
    <section id="alumni" class="content-section">
      <h2>Alumni Directory</h2>
      <div class="search-bar">
        <input type="text" id="alumniSearch" placeholder="Search alumni by name, company, or skills...">
        <select id="departmentFilter">
          <option value="">All Departments</option>
          <option value="Agricultural Engineering">Agricultural Engineering</option>
          <option value="Artificial Intelligence and Data Science">Artificial Intelligence and Data Science</option>
          <option value="Artificial Intelligence and Machine Learning">Artificial Intelligence and Machine Learning</option>
          <option value="Bio Medical">Bio Medical</option>
          <option value="Bio Technology">Bio Technology</option>
          <option value="Civil Engineering">Civil Engineering</option>
          <option value="Computer Science and Engineering">Computer Science and Engineering</option>
          <option value="Cyber Security">Cyber Security</option>
          <option value="Electrical and Electronics Engineering">Electrical and Electronics Engineering</option>
          <option value="Electronics and Communication Engineering">Electronics and Communication Engineering</option>
          <option value="Electronics Engineering (VLSI Design and Technology)">Electronics Engineering (VLSI Design and Technology)</option>
          <option value="Food Technology">Food Technology</option>
          <option value="Information Technology">Information Technology</option>
          <option value="Mechanical Engineering">Mechanical Engineering</option>
        </select>
        <button id="searchAlumniBtn"><i class="fas fa-search"></i> Search</button>
      </div>
      <div class="alumni-grid" id="alumniGrid">
        <p style="text-align: center; padding: 40px;">Loading alumni...</p>
      </div>
    </section>

    <!-- Chat Section -->
    <section id="chat" class="content-section">
      <h2>Messages</h2>
      <div class="chat-container">
        <div class="chat-list">
          <div class="chat-search">
            <input type="text" placeholder="Search conversations...">
          </div>
          <div id="conversationsList">
            <p style="text-align: center; padding: 40px; color: #999;">No conversations yet</p>
          </div>
        </div>
        <div class="chat-messages">
          <div class="chat-header">
            <div class="chat-avatar">A</div>
            <div>
              <h4 id="chatContactName">Select a conversation</h4>
              <p class="status-text">Online</p>
            </div>
          </div>
          <div class="message-area" id="messageArea">
            <p style="text-align: center; color: #999; padding: 40px;">Select a conversation to start messaging</p>
          </div>
          <div class="message-input">
            <input type="text" id="messageInput" placeholder="Type a message..." disabled>
            <button id="sendMessageBtn" disabled>
              <i class="fas fa-paper-plane"></i> Send
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Events Section -->
    <section id="events" class="content-section">
      <h2>Upcoming Events</h2>
      <div class="events-container">
        <div style="background: #f0f7ff; padding: 16px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #60a5fa;">
          <p style="color: #1e293b; margin: 0;">
            <i class="fas fa-info-circle" style="color: #60a5fa; margin-right: 8px;"></i>
            Events are organized by administrators and alumni. Browse and register for events below.
          </p>
        </div>
        <div class="events-grid" id="eventsGrid">
          <p style="text-align: center; padding: 40px;">Loading events...</p>
        </div>
      </div>
    </section>

    <!-- Jobs Section -->
    <section id="jobs" class="content-section">
      <h2>Job Opportunities</h2>
      <div class="search-bar">
        <input type="text" id="jobSearch" placeholder="Search jobs by title, company, or skills...">
        <select id="jobTypeFilter">
          <option value="">All Types</option>
          <option value="Full-time">Full-time</option>
          <option value="Internship">Internship</option>
          <option value="Part-time">Part-time</option>
        </select>
        <button id="searchJobsBtn"><i class="fas fa-search"></i> Search</button>
      </div>
      <div class="jobs-grid" id="jobsGrid">
        <p style="text-align: center; padding: 40px;">Loading job opportunities...</p>
      </div>
    </section>
  </main>

  <!-- Edit Profile Modal -->
  <div id="editProfileModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Profile</h3>
        <button class="close-modal" id="closeModalBtn">&times;</button>
      </div>
      <form id="editProfileForm">
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="editName" required>
        </div>
        <div class="form-group">
          <label>Year of Study</label>
          <select id="editYear" required>
            <option value="1st Year">1st Year</option>
            <option value="2nd Year">2nd Year</option>
            <option value="3rd Year">3rd Year</option>
            <option value="4th Year">4th Year</option>
          </select>
        </div>
        <div class="form-group">
          <label>Department</label>
          <select id="editDepartment" required>
            <option value="Computer Science and Engineering">Computer Science and Engineering</option>
            <option value="Information Technology">Information Technology</option>
            <option value="Mechanical Engineering">Mechanical Engineering</option>
            <option value="Civil Engineering">Civil Engineering</option>
            <option value="Electrical and Electronics Engineering">Electrical and Electronics Engineering</option>
          </select>
        </div>
        <div class="form-group">
          <label>Student ID</label>
          <input type="text" id="editStudentId" required>
        </div>
        <div class="form-group">
          <label>Skills</label>
          <div class="skills-input-wrapper">
            <input type="text" id="newSkill" placeholder="Add a skill">
            <button type="button" class="add-skill-btn" id="addSkillBtn">
              <i class="fas fa-plus"></i>
            </button>
          </div>
          <div class="skills-list-edit" id="skillsListEdit"></div>
        </div>
        <div class="form-group">
          <label>Achievements (one per line)</label>
          <textarea id="editAchievements" placeholder="Enter achievements..."></textarea>
        </div>
        <button type="submit" class="save-profile-btn">
          <i class="fas fa-save"></i> Save Changes
        </button>
      </form>
    </div>
  </div>

  <!-- Firebase Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      query, 
      where, 
      orderBy,
      addDoc, 
      getDoc, 
      getDocs,
      doc, 
      updateDoc,
      setDoc,
      onSnapshot,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhdtT0VMBmz8-vsVVa9KlcycSHnvtyxE4",
      authDomain: "alumni-connection-007.firebaseapp.com",
      projectId: "alumni-connection-007",
      storageBucket: "alumni-connection-007.appspot.com",
      messagingSenderId: "210833800961",
      appId: "1:210833800961:web:cb46b2ef133bd0d48a6500",
      measurementId: "G-MJQ8BJ5520"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let currentConversationId = null;
    let unsubscribeMessages = null;
    let allAlumni = [];
    let currentProfileData = {};
    let editSkills = [];

    const getInitials = (name = '') => {
      return name.split(' ').map(word => word[0]?.toUpperCase() || '').join('').slice(0, 2);
    };

    // Navigation
    document.querySelectorAll('.nav-links li[data-page]').forEach(item => {
      item.addEventListener('click', () => {
        document.querySelectorAll('.nav-links li').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        
        document.querySelectorAll('.content-section').forEach(section => {
          section.classList.remove('active');
        });
        
        const pageId = item.getAttribute('data-page');
        document.getElementById(pageId).classList.add('active');
        
        if (pageId === 'alumni') loadAlumni();
        if (pageId === 'chat') loadConversations();
        if (pageId === 'events') loadEvents();
        if (pageId === 'jobs') loadJobs();
      });
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await signOut(auth);
      window.location.href = 'index.html';
    });

    // Load Student Profile
    async function loadStudentProfile(uid) {
      try {
        const profileDoc = await getDoc(doc(db, 'students', uid));
        if (profileDoc.exists()) {
          const data = profileDoc.data();
          currentProfileData = data;
          
          document.getElementById('profileName').textContent = data.name || 'Student';
          document.getElementById('welcomeUsername').textContent = data.name || 'Student';
          document.getElementById('email').textContent = data.email || '';
          document.getElementById('yearOfStudy').textContent = data.yearOfStudy || '';
          document.getElementById('department').textContent = data.department || '';
          document.getElementById('studentId').textContent = data.studentId || '';
          document.getElementById('profileDepartment').textContent = data.department || '';
          
          const initials = getInitials(data.name || 'Student');
          document.getElementById('userAvatar').textContent = initials;
          document.getElementById('profileAvatar').textContent = initials;

          if (data.skills?.length) {
            document.getElementById('skillsList').innerHTML = data.skills.map(skill => 
              `<span class="skill-tag">${skill}</span>`
            ).join('');
          }

          if (data.achievements?.length) {
            document.getElementById('achievementsList').innerHTML = data.achievements.map(achievement => 
              `<li>${achievement}</li>`
            ).join('');
          }
        }
      } catch (error) {
        console.error('Error loading profile:', error);
      }
    }

    // Edit Profile Modal
    document.getElementById('editProfileBtn').addEventListener('click', () => {
      const modal = document.getElementById('editProfileModal');
      modal.classList.add('active');
      
      // Populate form with current data
      document.getElementById('editName').value = currentProfileData.name || '';
      document.getElementById('editYear').value = currentProfileData.yearOfStudy || '';
      document.getElementById('editDepartment').value = currentProfileData.department || '';
      document.getElementById('editStudentId').value = currentProfileData.studentId || '';
      
      editSkills = [...(currentProfileData.skills || [])];
      renderEditSkills();
      
      document.getElementById('editAchievements').value = (currentProfileData.achievements || []).join('\n');
    });

    document.getElementById('closeModalBtn').addEventListener('click', () => {
      document.getElementById('editProfileModal').classList.remove('active');
    });

    // Skills management in edit modal
    function renderEditSkills() {
      const container = document.getElementById('skillsListEdit');
      container.innerHTML = editSkills.map((skill, index) => `
        <div class="skill-tag-edit">
          ${skill}
          <button type="button" class="remove-skill" data-index="${index}">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `).join('');

      document.querySelectorAll('.remove-skill').forEach(btn => {
        btn.addEventListener('click', () => {
          const index = parseInt(btn.dataset.index);
          editSkills.splice(index, 1);
          renderEditSkills();
        });
      });
    }

    document.getElementById('addSkillBtn').addEventListener('click', () => {
      const input = document.getElementById('newSkill');
      const skill = input.value.trim();
      if (skill && !editSkills.includes(skill)) {
        editSkills.push(skill);
        renderEditSkills();
        input.value = '';
      }
    });

    // Save profile changes
    document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const updatedData = {
        name: document.getElementById('editName').value.trim(),
        yearOfStudy: document.getElementById('editYear').value,
        department: document.getElementById('editDepartment').value,
        studentId: document.getElementById('editStudentId').value.trim(),
        skills: editSkills,
        achievements: document.getElementById('editAchievements').value
          .split('\n')
          .filter(a => a.trim())
          .map(a => a.trim()),
        updatedAt: new Date()
      };

      try {
        await setDoc(doc(db, 'students', currentUser.uid), {
          ...currentProfileData,
          ...updatedData
        });
        
        alert('Profile updated successfully!');
        document.getElementById('editProfileModal').classList.remove('active');
        await loadStudentProfile(currentUser.uid);
      } catch (error) {
        console.error('Error updating profile:', error);
        alert('Failed to update profile: ' + error.message);
      }
    });

    // Load Alumni with WORKING SEARCH
    async function loadAlumni() {
      const alumniGrid = document.getElementById('alumniGrid');
      alumniGrid.innerHTML = '<p style="text-align: center; padding: 40px;">Loading alumni...</p>';

      try {
        const alumniSnap = await getDocs(collection(db, 'alumni'));
        allAlumni = [];
        
        alumniSnap.forEach(docSnap => {
          allAlumni.push({
            id: docSnap.id,
            ...docSnap.data()
          });
        });

        filterAndDisplayAlumni();
      } catch (error) {
        console.error('Error loading alumni:', error);
        alumniGrid.innerHTML = '<p style="color: red; padding: 20px;">Error loading alumni.</p>';
      }
    }

    function filterAndDisplayAlumni() {
      const searchTerm = document.getElementById('alumniSearch').value.toLowerCase();
      const departmentFilter = document.getElementById('departmentFilter').value;
      const alumniGrid = document.getElementById('alumniGrid');

      let filtered = allAlumni.filter(alumni => {
        const matchesSearch = !searchTerm || 
          (alumni.name || '').toLowerCase().includes(searchTerm) ||
          (alumni.company || '').toLowerCase().includes(searchTerm) ||
          (alumni.position || '').toLowerCase().includes(searchTerm) ||
          (alumni.skills || []).some(skill => skill.toLowerCase().includes(searchTerm));

        const matchesDept = !departmentFilter || alumni.department === departmentFilter;

        return matchesSearch && matchesDept;
      });

      if (filtered.length === 0) {
        alumniGrid.innerHTML = '<p style="text-align: center; padding: 40px;">No alumni found matching your search.</p>';
        return;
      }

      const alumniHtml = filtered.map(alumni => `
        <div class="alumni-card">
          <div class="alumni-header">
            <div class="alumni-avatar">${getInitials(alumni.name || 'Alumni')}</div>
            <h3>${alumni.name || 'Unknown'}</h3>
            <p class="alumni-position">${alumni.position || 'Position not set'}</p>
          </div>
          <div class="alumni-info">
            <p><i class="fas fa-building"></i> ${alumni.company || 'Company not set'}</p>
            <p><i class="fas fa-graduation-cap"></i> ${alumni.department || 'N/A'}</p>
            <p><i class="fas fa-calendar"></i> Class of ${alumni.graduationYear || 'N/A'}</p>
            <p><i class="fas fa-envelope"></i> ${alumni.email || ''}</p>
          </div>
          <div class="alumni-actions">
            <button class="connect-btn" data-id="${alumni.id}" data-name="${alumni.name}">
              <i class="fas fa-user-plus"></i> Connect
            </button>
            <button class="message-btn" data-id="${alumni.id}" data-name="${alumni.name}">
              <i class="fas fa-comment"></i> Message
            </button>
          </div>
        </div>
      `).join('');

      alumniGrid.innerHTML = alumniHtml;

      document.querySelectorAll('.connect-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          await sendConnectionRequest(btn.dataset.id, btn.dataset.name);
        });
      });

      document.querySelectorAll('.message-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          startConversation(btn.dataset.id, btn.dataset.name);
        });
      });
    }

    // Search button event listener
    document.getElementById('searchAlumniBtn').addEventListener('click', filterAndDisplayAlumni);
    document.getElementById('alumniSearch').addEventListener('keyup', (e) => {
      if (e.key === 'Enter') filterAndDisplayAlumni();
    });
    document.getElementById('departmentFilter').addEventListener('change', filterAndDisplayAlumni);

    // Job search event listeners
    document.getElementById('searchJobsBtn').addEventListener('click', filterAndDisplayJobs);
    document.getElementById('jobSearch').addEventListener('keyup', (e) => {
      if (e.key === 'Enter') filterAndDisplayJobs();
    });
    document.getElementById('jobTypeFilter').addEventListener('change', filterAndDisplayJobs);

    // Chat search event listener
    const chatSearchInput = document.querySelector('.chat-search input');
    if (chatSearchInput) {
      chatSearchInput.addEventListener('keyup', filterConversations);
      chatSearchInput.addEventListener('input', filterConversations);
    }

    async function sendConnectionRequest(alumniId, alumniName) {
      try {
        const studentDoc = await getDoc(doc(db, 'students', currentUser.uid));
        const studentData = studentDoc.data();

        await addDoc(collection(db, 'requests'), {
          fromId: currentUser.uid,
          toId: alumniId,
          status: 'pending',
          type: 'connection',
          message: 'Would like to connect with you',
          studentName: studentData.name,
          department: studentData.department,
          year: studentData.yearOfStudy,
          timestamp: serverTimestamp()
        });

        alert(`Connection request sent to ${alumniName}!`);
      } catch (error) {
        console.error('Error sending connection request:', error);
        alert('Failed to send connection request.');
      }
    }

    async function startConversation(alumniId, alumniName) {
      try {
        const convQuery = query(
          collection(db, 'conversations'),
          where('participants', 'array-contains', currentUser.uid)
        );
        const convSnap = await getDocs(convQuery);
        
        let conversationId = null;
        convSnap.forEach(docSnap => {
          const data = docSnap.data();
          if (data.participants.includes(alumniId)) {
            conversationId = docSnap.id;
          }
        });

        if (!conversationId) {
          const studentDoc = await getDoc(doc(db, 'students', currentUser.uid));
          const studentData = studentDoc.data();
          
          const convRef = await addDoc(collection(db, 'conversations'), {
            participants: [currentUser.uid, alumniId],
            participantNames: { 
              [currentUser.uid]: studentData.name || 'Student', 
              [alumniId]: alumniName 
            },
            lastMessage: '',
            lastMessageTime: serverTimestamp(),
            unreadCount: { 
              [currentUser.uid]: 0, 
              [alumniId]: 0 
            }
          });
          conversationId = convRef.id;
        }

        document.querySelector('[data-page="chat"]').click();
        setTimeout(() => {
          loadConversation(conversationId, alumniName);
        }, 300);
      } catch (error) {
        console.error('Error starting conversation:', error);
        alert('Failed to start conversation.');
      }
    }

    function loadConversations() {
      const conversationsList = document.getElementById('conversationsList');
      
      const convQuery = query(
        collection(db, 'conversations'),
        where('participants', 'array-contains', currentUser.uid)
      );

      onSnapshot(convQuery, (snapshot) => {
        if (snapshot.empty) {
          conversationsList.innerHTML = '<p style="padding: 40px; text-align: center;">No conversations yet</p>';
          return;
        }

        window.allConversations = [];
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const timestamp = data.lastMessageTime?.toDate ? data.lastMessageTime.toDate().getTime() : 0;
          window.allConversations.push({ id: docSnap.id, data, timestamp });
        });

        displayConversations(window.allConversations);
      });
    }

    function displayConversations(conversations) {
      const conversationsList = document.getElementById('conversationsList');
      
      if (conversations.length === 0) {
        conversationsList.innerHTML = '<p style="padding: 40px; text-align: center;">No conversations found</p>';
        return;
      }

      conversations.sort((a, b) => b.timestamp - a.timestamp);

      conversationsList.innerHTML = conversations.map(conv => {
        const otherUserId = conv.data.participants.find(id => id !== currentUser.uid);
        const otherUserName = conv.data.participantNames?.[otherUserId] || 'Unknown';
        const unreadCount = conv.data.unreadCount?.[currentUser.uid] || 0;

        return `
          <div class="conversation-item" data-id="${conv.id}" data-name="${otherUserName}">
            <div class="chat-avatar">${getInitials(otherUserName)}</div>
            <div style="flex: 1;">
              <h4>${otherUserName}</h4>
              <p style="color: #999; font-size: 14px;">${conv.data.lastMessage || 'No messages yet'}</p>
            </div>
            ${unreadCount > 0 ? `<span class="badge">${unreadCount}</span>` : ''}
          </div>
        `;
      }).join('');

      document.querySelectorAll('.conversation-item').forEach(item => {
        item.addEventListener('click', () => {
          loadConversation(item.getAttribute('data-id'), item.getAttribute('data-name'));
        });
      });
    }

    function filterConversations() {
      const searchTerm = document.querySelector('.chat-search input').value.toLowerCase();
      const filtered = (window.allConversations || []).filter(conv => {
        const otherUserId = conv.data.participants.find(id => id !== currentUser.uid);
        const otherUserName = (conv.data.participantNames?.[otherUserId] || 'Unknown').toLowerCase();
        return otherUserName.includes(searchTerm);
      });
      displayConversations(filtered);
    }

    function loadConversation(conversationId, contactName) {
      currentConversationId = conversationId;
      
      document.getElementById('chatContactName').textContent = contactName;
      document.getElementById('messageInput').disabled = false;
      document.getElementById('sendMessageBtn').disabled = false;

      if (unsubscribeMessages) unsubscribeMessages();

      updateDoc(doc(db, 'conversations', conversationId), {
        [`unreadCount.${currentUser.uid}`]: 0
      }).catch(err => console.error('Error marking as read:', err));

      const messagesQuery = query(
        collection(db, 'conversations', conversationId, 'messages'),
        orderBy('timestamp', 'asc')
      );

      unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
        const messageArea = document.getElementById('messageArea');
        messageArea.innerHTML = '';
        
        if (snapshot.empty) {
          messageArea.innerHTML = '<p style="text-align: center; padding: 40px;">No messages yet.</p>';
          return;
        }

        snapshot.forEach(docSnap => {
          const msg = docSnap.data();
          const isSent = msg.senderId === currentUser.uid;
          const timestamp = msg.timestamp?.toDate();

          const messageEl = document.createElement('div');
          messageEl.className = `message ${isSent ? 'sent' : 'received'}`;
          
          const contentDiv = document.createElement('div');
          contentDiv.className = 'message-content';
          contentDiv.style.backgroundColor = isSent ? '#007bff' : '#f0f2f5';
          contentDiv.style.color = isSent ? 'white' : '#1e293b';
          
          const textPara = document.createElement('p');
          textPara.textContent = msg.text;
          textPara.style.color = isSent ? 'white' : '#1e293b';
          textPara.style.margin = '0';
          textPara.style.wordWrap = 'break-word';
          textPara.style.whiteSpace = 'normal';
          
          contentDiv.appendChild(textPara);
          
          if (timestamp) {
            const timeSpan = document.createElement('span');
            timeSpan.className = 'message-time';
            timeSpan.textContent = timestamp.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            timeSpan.style.color = isSent ? 'rgba(255,255,255,0.8)' : '#666';
            timeSpan.style.fontSize = '0.8em';
            timeSpan.style.marginTop = '5px';
            timeSpan.style.display = 'block';
            contentDiv.appendChild(timeSpan);
          }
          
          messageEl.appendChild(contentDiv);
          messageArea.appendChild(messageEl);
        });

        messageArea.scrollTop = messageArea.scrollHeight;
      });
    }

    async function sendMessage() {
      const messageInput = document.getElementById('messageInput');
      const text = messageInput.value.trim();

      if (!text || !currentConversationId) return;

      try {
        await addDoc(collection(db, 'conversations', currentConversationId, 'messages'), {
          text,
          senderId: currentUser.uid,
          timestamp: serverTimestamp()
        });

        const convDoc = await getDoc(doc(db, 'conversations', currentConversationId));
        const convData = convDoc.data();
        const otherUserId = convData.participants.find(id => id !== currentUser.uid);

        await updateDoc(doc(db, 'conversations', currentConversationId), {
          lastMessage: text,
          lastMessageTime: serverTimestamp(),
          [`unreadCount.${otherUserId}`]: (convData.unreadCount?.[otherUserId] || 0) + 1
        });

        messageInput.value = '';
      } catch (error) {
        console.error('Error sending message:', error);
      }
    }

    document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    async function loadEvents() {
      const eventsGrid = document.getElementById('eventsGrid');
      eventsGrid.innerHTML = '<p style="text-align: center; padding: 40px;">Loading events...</p>';

      try {
        const eventsSnap = await getDocs(collection(db, 'events'));
        if (eventsSnap.empty) {
          eventsGrid.innerHTML = '<p style="text-align: center; padding: 40px;">No events found.</p>';
          return;
        }

        const eventsHtml = [];
        eventsSnap.forEach(docSnap => {
          const event = docSnap.data();
          eventsHtml.push(`
            <div class="event-card">
              <h3>${event.title || ''}</h3>
              <div class="event-info">
                <p><i class="fas fa-calendar"></i> ${event.date || ''}</p>
                <p><i class="fas fa-clock"></i> ${event.time || ''}</p>
                <p><i class="fas fa-map-marker-alt"></i> ${event.location || ''}</p>
              </div>
              <p>${event.description || ''}</p>
              <button class="register-btn" onclick="alert('Registration feature coming soon!')">
                <i class="fas fa-check-circle"></i> Register
              </button>
            </div>
          `);
        });

        eventsGrid.innerHTML = eventsHtml.join('');
      } catch (error) {
        console.error('Error loading events:', error);
        eventsGrid.innerHTML = '<p style="color: red;">Error loading events.</p>';
      }
    }

    async function loadJobs() {
      const jobsGrid = document.getElementById('jobsGrid');
      jobsGrid.innerHTML = '<p style="text-align: center; padding: 40px;">Loading jobs...</p>';

      try {
        const jobsSnap = await getDocs(collection(db, 'jobs'));
        if (jobsSnap.empty) {
          jobsGrid.innerHTML = '<p style="text-align: center; padding: 40px;">No jobs found.</p>';
          return;
        }

        window.allJobs = [];
        jobsSnap.forEach(docSnap => {
          const job = docSnap.data();
          window.allJobs.push({ id: docSnap.id, ...job });
        });

        filterAndDisplayJobs();
      } catch (error) {
        console.error('Error loading jobs:', error);
        jobsGrid.innerHTML = '<p style="color: red;">Error loading jobs.</p>';
      }
    }

    function filterAndDisplayJobs() {
      const searchTerm = document.getElementById('jobSearch').value.toLowerCase();
      const jobTypeFilter = document.getElementById('jobTypeFilter').value;
      const jobsGrid = document.getElementById('jobsGrid');

      let filtered = (window.allJobs || []).filter(job => {
        const matchesSearch = !searchTerm || 
          (job.title || '').toLowerCase().includes(searchTerm) ||
          (job.company || '').toLowerCase().includes(searchTerm) ||
          (job.description || '').toLowerCase().includes(searchTerm);

        const matchesType = !jobTypeFilter || job.type === jobTypeFilter;

        return matchesSearch && matchesType;
      });

      if (filtered.length === 0) {
        jobsGrid.innerHTML = '<p style="text-align: center; padding: 40px;">No jobs found matching your search.</p>';
        return;
      }

      const jobsHtml = filtered.map(job => `
        <div class="job-card">
          <div class="job-header">
            <h3>${job.title || ''}</h3>
            <span class="job-type ${job.type?.toLowerCase()}">${job.type || 'Full-time'}</span>
          </div>
          <div class="job-info">
            <p><i class="fas fa-building"></i> ${job.company || ''}</p>
            <p><i class="fas fa-map-marker-alt"></i> ${job.location || ''}</p>
          </div>
          <p>${job.description || ''}</p>
          <button class="register-btn" onclick="alert('Application feature coming soon!')">
            <i class="fas fa-paper-plane"></i> Apply Now
          </button>
        </div>
      `).join('');

      jobsGrid.innerHTML = jobsHtml;
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        await loadStudentProfile(user.uid);
        await loadAlumni();
      } else {
        window.location.href = 'index.html';
      }
    });
  </script>

  <!-- Mobile Menu Toggle Script -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Create hamburger menu button
      const menuToggle = document.createElement('button');
      menuToggle.className = 'menu-toggle';
      menuToggle.innerHTML = '<i class="fas fa-bars"></i>';
      menuToggle.setAttribute('aria-label', 'Toggle menu');
      
      // Create overlay
      const overlay = document.createElement('div');
      overlay.className = 'sidebar-overlay';
      
      // Insert elements into DOM
      document.body.insertBefore(menuToggle, document.body.firstChild);
      document.body.insertBefore(overlay, document.body.firstChild);
      
      const sidebar = document.querySelector('.sidebar');
      
      // Toggle menu function
      function toggleMenu() {
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
        
        // Change icon
        const icon = menuToggle.querySelector('i');
        if (sidebar.classList.contains('active')) {
          icon.className = 'fas fa-times';
        } else {
          icon.className = 'fas fa-bars';
        }
      }
      
      // Event listeners
      menuToggle.addEventListener('click', toggleMenu);
      overlay.addEventListener('click', toggleMenu);
      
      // Close menu when clicking on a nav item (mobile only)
      const navLinks = document.querySelectorAll('.nav-links li');
      navLinks.forEach(link => {
        link.addEventListener('click', function() {
          if (window.innerWidth <= 768) {
            toggleMenu();
          }
        });
      });
      
      // Close menu on window resize if screen becomes larger
      window.addEventListener('resize', function() {
        if (window.innerWidth > 768) {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
          menuToggle.querySelector('i').className = 'fas fa-bars';
        }
      });
      
      // Prevent body scroll when menu is open
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.attributeName === 'class') {
            if (sidebar.classList.contains('active')) {
              document.body.style.overflow = 'hidden';
            } else {
              document.body.style.overflow = '';
            }
          }
        });
      });
      
      observer.observe(sidebar, { attributes: true });
    });
  </script>
</body>
</html>