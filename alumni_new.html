<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alumni Dashboard - Alumni Connection</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    /* Smaller edit button in corner */
    .profile-header {
      position: relative;
      padding-bottom: 20px;
      margin-bottom: 30px;
      border-bottom: 2px solid #f0f0f0;
    }

    .profile-info-wrapper {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .edit-profile-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: linear-gradient(135deg, #60a5fa, #818cf8);
      color: white;
      border: none;
      padding: 6px 6px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 6px rgba(96, 165, 250, 0.3);
      z-index: 10;
      line-height: 1;
    }

    .edit-profile-btn:hover {
      background: linear-gradient(135deg, #3b82f6, #6366f1);
      transform: scale(1.15);
      box-shadow: 0 3px 10px rgba(96, 165, 250, 0.4);
    }

    /* Edit Profile Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      animation: fadeIn 0.3s ease;
    }

    .modal.active {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .modal-header h3 {
      font-size: 1.5rem;
      color: #1e293b;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #64748b;
      transition: color 0.3s ease;
    }

    .close-modal:hover {
      color: #1e293b;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #475569;
      font-weight: 500;
      font-size: 0.9rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #cbd5e0;
      border-radius: 10px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #60a5fa;
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
    }

    .skills-input-wrapper {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .skills-input-wrapper input {
      flex: 1;
    }

    .add-skill-btn {
      background: #60a5fa;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .add-skill-btn:hover {
      background: #3b82f6;
    }

    .skills-list-edit {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .skill-tag-edit {
      background: #e0f2fe;
      color: #0369a1;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .remove-skill {
      background: none;
      border: none;
      color: #0369a1;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 0;
      display: flex;
      align-items: center;
    }

    .remove-skill:hover {
      color: #dc2626;
    }

    .save-profile-btn {
      width: 100%;
      background: linear-gradient(135deg, #60a5fa, #818cf8);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }

    .save-profile-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
    }

    /* CRITICAL CHAT INPUT VISIBILITY FIX */
    .message-input {
      padding: 20px !important;
      border-top: 1px solid #eee !important;
      display: flex !important;
      gap: 10px !important;
      background: white !important;
    }

    .message-input input {
      color: #1e293b !important;
      -webkit-text-fill-color: #1e293b !important;
      background: #ffffff !important;
      font-size: 1rem !important;
      line-height: 1.5 !important;
      opacity: 1 !important;
      padding: 12px 16px !important;
      border: 2px solid #cbd5e0 !important;
      border-radius: 8px !important;
      caret-color: #60a5fa !important;
      font-family: 'Inter', sans-serif !important;
      flex: 1 !important;
    }

    .message-input input::selection {
      background: rgba(96, 165, 250, 0.3) !important;
      color: #1e293b !important;
    }
    
    .message-input input:focus {
      background: #ffffff !important;
      color: #1e293b !important;
      -webkit-text-fill-color: #1e293b !important;
      border-color: #60a5fa !important;
      border-width: 2px !important;
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1) !important;
      outline: none !important;
    }
    
    .message-input input::placeholder {
      color: #94a3b8 !important;
      -webkit-text-fill-color: #94a3b8 !important;
      opacity: 1 !important;
    }
    
    .message-input input:disabled {
      background: #f1f5f9 !important;
      color: #94a3b8 !important;
      -webkit-text-fill-color: #94a3b8 !important;
      cursor: not-allowed !important;
      opacity: 0.6 !important;
      border-color: #cbd5e0 !important;
    }
    
    .message-content {
      max-width: 70% !important;
      padding: 12px !important;
      border-radius: 12px !important;
      position: relative !important;
      word-wrap: break-word !important;
      word-break: break-word !important;
    }

    .message-content p {
      color: #1e293b !important;
      -webkit-text-fill-color: #1e293b !important;
      display: block !important;
      visibility: visible !important;
      margin: 0 !important;
      white-space: normal !important;
      word-wrap: break-word !important;
      font-size: 1rem !important;
    }
    
    .message.sent .message-content {
      background: #007bff !important;
      color: white !important;
      -webkit-text-fill-color: white !important;
    }

    .message.sent .message-content p {
      color: white !important;
      -webkit-text-fill-color: white !important;
    }
    
    .message.received .message-content {
      background: #f0f2f5 !important;
      color: #1e293b !important;
    }

    .message.received .message-content p {
      color: #1e293b !important;
      -webkit-text-fill-color: #1e293b !important;
    }
  </style>
</head>
<body class="dashboard-body">
  <!-- Sidebar Navigation -->
  <nav class="sidebar">
    <div class="sidebar-header">
      <div class="avatar" id="userAvatar">A</div>
      <h3 id="welcomeUsername">Alumni</h3>
      <p class="status-text">Active</p>
    </div>
    <ul class="nav-links">
      <li class="active" data-page="profile">
        <i class="fas fa-user"></i>
        <span>My Profile</span>
      </li>
      <li data-page="requests">
        <i class="fas fa-bell"></i>
        <span>Requests</span>
        <span class="badge" id="requestCount" style="display: none;">0</span>
      </li>
      <li data-page="chat">
        <i class="fas fa-comments"></i>
        <span>Messages</span>
        <span class="badge" id="unreadCount" style="display: none;">0</span>
      </li>
      <li data-page="jobs">
        <i class="fas fa-briefcase"></i>
        <span>Job Posts</span>
      </li>
      <li data-page="events">
        <i class="fas fa-calendar"></i>
        <span>Events</span>
      </li>
      <li id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i>
        <span>Logout</span>
      </li>
    </ul>
  </nav>

  <!-- Main Content Area -->
  <main class="main-content">
    <!-- Profile Section -->
    <section id="profile" class="content-section active">
      <h2>My Profile</h2>
      <div class="profile-card">
        <div class="profile-header">
          <div class="profile-info-wrapper">
            <div class="avatar large-profile-pic" id="profileAvatar">A</div>
            <div>
              <h3 id="profileName">Alumni Name</h3>
              <p class="alumni-position" id="profilePosition">Position</p>
            </div>
          </div>
          <button class="edit-profile-btn" id="editProfileBtn" title="Edit Profile">
            <i class="fas fa-edit\"></i>
          </button>
        </div>

        <div class="info-group">
          <label>Email</label>
          <p id="email">alumni@example.com</p>
        </div>

        <div class="info-group">
          <label>Department</label>
          <p id="department">Computer Science</p>
        </div>

        <div class="info-group">
          <label>Graduation Year</label>
          <p id="graduationYear">2020</p>
        </div>

        <div class="info-group">
          <label>Current Company</label>
          <p id="company">Company Name</p>
        </div>

        <div class="info-group">
          <label>Current Position</label>
          <p id="position">Software Engineer</p>
        </div>

        <div class="info-group">
          <label>Skills</label>
          <div class="skills-list" id="skillsList">
            <span class="skill-tag">JavaScript</span>
            <span class="skill-tag">Python</span>
            <span class="skill-tag">Leadership</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Requests Section -->
    <section id="requests" class="content-section">
      <h2>Student Requests</h2>
      <div class="requests-container">
        <div class="filters">
          <select id="statusFilter">
            <option value="">All Status</option>
            <option value="pending">Pending</option>
            <option value="accepted">Accepted</option>
            <option value="declined">Declined</option>
          </select>
          <select id="typeFilter">
            <option value="">All Types</option>
            <option value="mentorship">Mentorship</option>
            <option value="career-advice">Career Advice</option>
            <option value="connection">Connection</option>
          </select>
          <div class="search-box">
            <input type="text" id="requestSearch" placeholder="Search requests...">
            <i class="fas fa-search"></i>
          </div>
        </div>
        <div id="requestsGrid">
          <p style="text-align: center; padding: 40px;">Loading requests...</p>
        </div>
      </div>
    </section>

    <!-- Chat Section -->
    <section id="chat" class="content-section">
      <h2>Messages</h2>
      <div class="chat-container">
        <div class="chat-list">
          <div class="chat-search">
            <input type="text" placeholder="Search conversations...">
          </div>
          <div id="conversationsList">
            <p style="text-align: center; padding: 40px; color: #999;">No conversations yet</p>
          </div>
        </div>
        <div class="chat-messages">
          <div class="chat-header">
            <div class="chat-avatar">S</div>
            <div>
              <h4 id="chatContactName">Select a conversation</h4>
              <p class="status-text">Online</p>
            </div>
          </div>
          <div class="message-area" id="messageArea">
            <p style="text-align: center; color: #999; padding: 40px;">Select a conversation to start messaging</p>
          </div>
          <div class="message-input">
            <input type="text" id="messageInput" placeholder="Type a message..." disabled>
            <button id="sendMessageBtn" disabled>
              <i class="fas fa-paper-plane"></i> Send
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Job Posts Section -->
    <section id="jobs" class="content-section">
      <h2>Job Posts</h2>
      <div class="job-posts-container">
        <div class="job-actions">
          <button class="create-job-btn" id="createJobBtn">
            <i class="fas fa-plus"></i> Create Job Post
          </button>
          <div class="search-box">
            <input type="text" id="jobSearchInput" placeholder="Search jobs...">
            <i class="fas fa-search"></i>
          </div>
        </div>
        <div class="jobs-grid" id="jobsGrid">
          <p style="text-align: center; padding: 40px;">Loading job posts...</p>
        </div>
      </div>
    </section>

    <!-- Events Section -->
    <section id="events" class="content-section">
      <h2>Upcoming Events</h2>
      <div class="events-container">
        <div style="background: #f0f7ff; padding: 16px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #60a5fa;">
          <p style="color: #1e293b; margin: 0;">
            <i class="fas fa-info-circle" style="color: #60a5fa; margin-right: 8px;"></i>
            Events are managed by administrators. You can view and register for upcoming events below.
          </p>
        </div>
        <div class="events-grid" id="eventsGrid">
          <p style="text-align: center; padding: 40px;">Loading events...</p>
        </div>
      </div>
    </section>
  </main>

  <!-- Edit Profile Modal -->
  <div id="editProfileModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Profile</h3>
        <button class="close-modal" id="closeModalBtn">&times;</button>
      </div>
      <form id="editProfileForm">
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="editName" required>
        </div>
        <div class="form-group">
          <label>Department</label>
          <select id="editDepartment" required>
            <option value="Computer Science and Engineering">Computer Science and Engineering</option>
            <option value="Information Technology">Information Technology</option>
            <option value="Mechanical Engineering">Mechanical Engineering</option>
            <option value="Civil Engineering">Civil Engineering</option>
            <option value="Electrical and Electronics Engineering">Electrical and Electronics Engineering</option>
          </select>
        </div>
        <div class="form-group">
          <label>Graduation Year</label>
          <input type="number" id="editGradYear" min="1950" max="2025" required>
        </div>
        <div class="form-group">
          <label>Current Company</label>
          <input type="text" id="editCompany" required>
        </div>
        <div class="form-group">
          <label>Current Position</label>
          <input type="text" id="editPosition" required>
        </div>
        <div class="form-group">
          <label>Skills</label>
          <div class="skills-input-wrapper">
            <input type="text" id="newSkill" placeholder="Add a skill">
            <button type="button" class="add-skill-btn" id="addSkillBtn">
              <i class="fas fa-plus"></i>
            </button>
          </div>
          <div class="skills-list-edit" id="skillsListEdit"></div>
        </div>
        <button type="submit" class="save-profile-btn">
          <i class="fas fa-save"></i> Save Changes
        </button>
      </form>
    </div>
  </div>

  <!-- Firebase Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      query, 
      where, 
      orderBy,
      addDoc, 
      getDoc, 
      getDocs,
      doc,
      setDoc, 
      updateDoc,
      deleteDoc,
      onSnapshot,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhdtT0VMBmz8-vsVVa9KlcycSHnvtyxE4",
      authDomain: "alumni-connection-007.firebaseapp.com",
      projectId: "alumni-connection-007",
      storageBucket: "alumni-connection-007.appspot.com",
      messagingSenderId: "210833800961",
      appId: "1:210833800961:web:cb46b2ef133bd0d48a6500",
      measurementId: "G-MJQ8BJ5520"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let currentConversationId = null;
    let unsubscribeMessages = null;
    let currentProfileData = {};
    let editSkills = [];

    const getInitials = (name = '') => {
      return name.split(' ').map(word => word[0]?.toUpperCase() || '').join('').slice(0, 2);
    };

    // Navigation
    document.querySelectorAll('.nav-links li[data-page]').forEach(item => {
      item.addEventListener('click', () => {
        document.querySelectorAll('.nav-links li').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        
        document.querySelectorAll('.content-section').forEach(section => {
          section.classList.remove('active');
        });
        
        const pageId = item.getAttribute('data-page');
        document.getElementById(pageId).classList.add('active');
        
        if (pageId === 'requests') loadRequests();
        if (pageId === 'chat') loadConversations();
        if (pageId === 'jobs') loadJobs();
        if (pageId === 'events') loadEvents();
      });
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await signOut(auth);
      window.location.href = 'index.html';
    });

    // Load Alumni Profile
    async function loadAlumniProfile(uid) {
      try {
        const profileDoc = await getDoc(doc(db, 'alumni', uid));
        let profileData;
        
        if (profileDoc.exists()) {
          profileData = profileDoc.data();
        } else {
          const username = localStorage.getItem('username') || auth.currentUser?.email?.split('@')[0] || 'Alumni';
          const displayName = username.charAt(0).toUpperCase() + username.slice(1);
          
          profileData = {
            name: displayName,
            department: "Computer Science and Engineering",
            graduationYear: "2023",
            company: "",
            position: "",
            email: auth.currentUser?.email || "",
            skills: ["Software Development", "Cloud Computing", "Team Leadership"],
            createdAt: new Date()
          };
          
          await setDoc(doc(db, 'alumni', uid), profileData);
        }

        currentProfileData = profileData;
        const displayName = profileData.name;
        
        document.getElementById('welcomeUsername').textContent = displayName;
        document.getElementById('profileName').textContent = displayName;
        document.getElementById('email').textContent = profileData.email || '';
        document.getElementById('department').textContent = profileData.department || '';
        document.getElementById('graduationYear').textContent = profileData.graduationYear || '';
        document.getElementById('company').textContent = profileData.company || 'Not set';
        document.getElementById('position').textContent = profileData.position || 'Not set';
        document.getElementById('profilePosition').textContent = profileData.position || 'Not set';
        
        const initials = getInitials(displayName);
        document.getElementById('userAvatar').textContent = initials;
        document.getElementById('profileAvatar').textContent = initials;

        if (profileData.skills?.length) {
          document.getElementById('skillsList').innerHTML = profileData.skills.map(skill => 
            `<span class="skill-tag">${skill}</span>`
          ).join('');
        }

        return profileData;
      } catch (error) {
        console.error('Error loading profile:', error);
        throw error;
      }
    }

    // Edit Profile Modal
    document.getElementById('editProfileBtn').addEventListener('click', () => {
      const modal = document.getElementById('editProfileModal');
      modal.classList.add('active');
      
      document.getElementById('editName').value = currentProfileData.name || '';
      document.getElementById('editDepartment').value = currentProfileData.department || '';
      document.getElementById('editGradYear').value = currentProfileData.graduationYear || '';
      document.getElementById('editCompany').value = currentProfileData.company || '';
      document.getElementById('editPosition').value = currentProfileData.position || '';
      
      editSkills = [...(currentProfileData.skills || [])];
      renderEditSkills();
    });

    document.getElementById('closeModalBtn').addEventListener('click', () => {
      document.getElementById('editProfileModal').classList.remove('active');
    });

    function renderEditSkills() {
      const container = document.getElementById('skillsListEdit');
      container.innerHTML = editSkills.map((skill, index) => `
        <div class="skill-tag-edit">
          ${skill}
          <button type="button" class="remove-skill" data-index="${index}">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `).join('');

      document.querySelectorAll('.remove-skill').forEach(btn => {
        btn.addEventListener('click', () => {
          const index = parseInt(btn.dataset.index);
          editSkills.splice(index, 1);
          renderEditSkills();
        });
      });
    }

    document.getElementById('addSkillBtn').addEventListener('click', () => {
      const input = document.getElementById('newSkill');
      const skill = input.value.trim();
      if (skill && !editSkills.includes(skill)) {
        editSkills.push(skill);
        renderEditSkills();
        input.value = '';
      }
    });

    document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const updatedData = {
        name: document.getElementById('editName').value.trim(),
        department: document.getElementById('editDepartment').value,
        graduationYear: document.getElementById('editGradYear').value,
        company: document.getElementById('editCompany').value.trim(),
        position: document.getElementById('editPosition').value.trim(),
        skills: editSkills,
        updatedAt: new Date()
      };

      try {
        await setDoc(doc(db, 'alumni', currentUser.uid), {
          ...currentProfileData,
          ...updatedData
        });
        
        alert('Profile updated successfully!');
        document.getElementById('editProfileModal').classList.remove('active');
        await loadAlumniProfile(currentUser.uid);
      } catch (error) {
        console.error('Error updating profile:', error);
        alert('Failed to update profile: ' + error.message);
      }
    });

    // Load Requests
    async function loadRequests() {
      const requestsGrid = document.getElementById('requestsGrid');
      requestsGrid.innerHTML = '<p style="text-align: center; padding: 40px;">Loading requests...</p>';

      try {
        const requestsQuery = query(
          collection(db, 'requests'),
          where('toId', '==', currentUser.uid)
        );
        
        const requestsSnap = await getDocs(requestsQuery);
        
        if (requestsSnap.empty) {
          requestsGrid.innerHTML = '<p style="text-align: center; padding: 40px;">No requests found.</p>';
          return;
        }

        const requestsHtml = [];
        requestsSnap.forEach(docSnap => {
          const request = docSnap.data();
          requestsHtml.push(`
            <div class="request-card">
              <div class="request-header">
                <div class="student-avatar">${getInitials(request.studentName || 'Student')}</div>
                <div class="request-info">
                  <h4>${request.studentName || 'Unknown'}</h4>
                  <p>${request.department || ''} ${request.year ? '- ' + request.year : ''}</p>
                </div>
                <span class="request-type ${(request.type || 'general').toLowerCase()}">${request.type || 'General'}</span>
              </div>
              <p class="request-message">${request.message || ''}</p>
              <div class="request-actions">
                ${request.status === 'pending' ? `
                  <button class="accept-btn" data-id="${docSnap.id}"><i class="fas fa-check"></i> Accept</button>
                  <button class="decline-btn" data-id="${docSnap.id}"><i class="fas fa-times"></i> Decline</button>
                ` : `
                  <span class="status-badge ${request.status}">${request.status}</span>
                `}
                <span class="request-time">${request.timestamp ? new Date(request.timestamp.toDate()).toLocaleString() : ''}</span>
              </div>
            </div>
          `);
        });

        requestsGrid.innerHTML = requestsHtml.join('');

        document.querySelectorAll('.accept-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            try {
              await setDoc(doc(db, 'requests', btn.getAttribute('data-id')), {
                status: 'accepted',
                updatedAt: new Date()
              }, { merge: true });
              alert('Request accepted!');
              loadRequests();
            } catch (error) {
              console.error('Error accepting request:', error);
              alert('Failed to accept request.');
            }
          });
        });

        document.querySelectorAll('.decline-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            try {
              await setDoc(doc(db, 'requests', btn.getAttribute('data-id')), {
                status: 'declined',
                updatedAt: new Date()
              }, { merge: true });
              alert('Request declined!');
              loadRequests();
            } catch (error) {
              console.error('Error declining request:', error);
              alert('Failed to decline request.');
            }
          });
        });
      } catch (error) {
        console.error('Error loading requests:', error);
        requestsGrid.innerHTML = `<p style="color: red;">Error loading requests: ${error.message}</p>`;
      }
    }

    // Load Conversations
    function loadConversations() {
      const conversationsList = document.getElementById('conversationsList');
      
      const convQuery = query(
        collection(db, 'conversations'),
        where('participants', 'array-contains', currentUser.uid)
      );

      onSnapshot(convQuery, (snapshot) => {
        if (snapshot.empty) {
          conversationsList.innerHTML = '<p style="padding: 40px; text-align: center;">No conversations yet</p>';
          return;
        }

        window.allConversations = [];
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const timestamp = data.lastMessageTime?.toDate ? data.lastMessageTime.toDate().getTime() : 0;
          window.allConversations.push({ id: docSnap.id, data, timestamp });
        });

        displayConversations(window.allConversations);
      });
    }

    function displayConversations(conversations) {
      const conversationsList = document.getElementById('conversationsList');
      
      if (conversations.length === 0) {
        conversationsList.innerHTML = '<p style="padding: 40px; text-align: center;">No conversations found</p>';
        return;
      }

      conversations.sort((a, b) => b.timestamp - a.timestamp);

      conversationsList.innerHTML = conversations.map(conv => {
        const otherUserId = conv.data.participants.find(id => id !== currentUser.uid);
        const otherUserName = conv.data.participantNames?.[otherUserId] || 'Unknown';
        const unreadCount = conv.data.unreadCount?.[currentUser.uid] || 0;

        return `
          <div class="conversation-item" data-id="${conv.id}" data-name="${otherUserName}">
            <div class="chat-avatar">${getInitials(otherUserName)}</div>
            <div style="flex: 1;">
              <h4>${otherUserName}</h4>
              <p style="color: #999; font-size: 14px;">${conv.data.lastMessage || 'No messages yet'}</p>
            </div>
            ${unreadCount > 0 ? `<span class="badge">${unreadCount}</span>` : ''}
          </div>
        `;
      }).join('');

      document.querySelectorAll('.conversation-item').forEach(item => {
        item.addEventListener('click', () => {
          loadConversation(item.getAttribute('data-id'), item.getAttribute('data-name'));
        });
      });
    }

    function filterConversations() {
      const searchTerm = document.querySelector('.chat-search input').value.toLowerCase();
      const filtered = (window.allConversations || []).filter(conv => {
        const otherUserId = conv.data.participants.find(id => id !== currentUser.uid);
        const otherUserName = (conv.data.participantNames?.[otherUserId] || 'Unknown').toLowerCase();
        return otherUserName.includes(searchTerm);
      });
      displayConversations(filtered);
    }

    // Load Conversation
    function loadConversation(conversationId, contactName) {
      currentConversationId = conversationId;
      
      document.getElementById('chatContactName').textContent = contactName;
      document.getElementById('messageInput').disabled = false;
      document.getElementById('sendMessageBtn').disabled = false;

      if (unsubscribeMessages) unsubscribeMessages();

      updateDoc(doc(db, 'conversations', conversationId), {
        [`unreadCount.${currentUser.uid}`]: 0
      }).catch(err => console.error('Error marking as read:', err));

      const messagesQuery = query(
        collection(db, 'conversations', conversationId, 'messages'),
        orderBy('timestamp', 'asc')
      );

      unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
        const messageArea = document.getElementById('messageArea');
        messageArea.innerHTML = '';
        
        if (snapshot.empty) {
          messageArea.innerHTML = '<p style="text-align: center; padding: 40px;">No messages yet.</p>';
          return;
        }

        snapshot.forEach(docSnap => {
          const msg = docSnap.data();
          const isSent = msg.senderId === currentUser.uid;
          const timestamp = msg.timestamp?.toDate();

          const messageEl = document.createElement('div');
          messageEl.className = `message ${isSent ? 'sent' : 'received'}`;
          
          const contentDiv = document.createElement('div');
          contentDiv.className = 'message-content';
          contentDiv.style.backgroundColor = isSent ? '#007bff' : '#f0f2f5';
          contentDiv.style.color = isSent ? 'white' : '#1e293b';
          
          const textPara = document.createElement('p');
          textPara.textContent = msg.text;
          textPara.style.color = isSent ? 'white' : '#1e293b';
          textPara.style.margin = '0';
          textPara.style.wordWrap = 'break-word';
          textPara.style.whiteSpace = 'normal';
          
          contentDiv.appendChild(textPara);
          
          if (timestamp) {
            const timeSpan = document.createElement('span');
            timeSpan.className = 'message-time';
            timeSpan.textContent = timestamp.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            timeSpan.style.color = isSent ? 'rgba(255,255,255,0.8)' : '#666';
            timeSpan.style.fontSize = '0.8em';
            timeSpan.style.marginTop = '5px';
            timeSpan.style.display = 'block';
            contentDiv.appendChild(timeSpan);
          }
          
          messageEl.appendChild(contentDiv);
          messageArea.appendChild(messageEl);
        });

        messageArea.scrollTop = messageArea.scrollHeight;
      });
    }

    // Send Message
    async function sendMessage() {
      const messageInput = document.getElementById('messageInput');
      const text = messageInput.value.trim();

      if (!text || !currentConversationId) return;

      try {
        await addDoc(collection(db, 'conversations', currentConversationId, 'messages'), {
          text,
          senderId: currentUser.uid,
          timestamp: serverTimestamp()
        });

        const convDoc = await getDoc(doc(db, 'conversations', currentConversationId));
        const convData = convDoc.data();
        const otherUserId = convData.participants.find(id => id !== currentUser.uid);

        await updateDoc(doc(db, 'conversations', currentConversationId), {
          lastMessage: text,
          lastMessageTime: serverTimestamp(),
          [`unreadCount.${otherUserId}`]: (convData.unreadCount?.[otherUserId] || 0) + 1
        });

        messageInput.value = '';
      } catch (error) {
        console.error('Error sending message:', error);
        alert('Failed to send message.');
      }
    }

    document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Chat search event listener
    const chatSearchInput = document.querySelector('.chat-search input');
    if (chatSearchInput) {
      chatSearchInput.addEventListener('keyup', filterConversations);
      chatSearchInput.addEventListener('input', filterConversations);
    }

    // Load Jobs
    async function loadJobs() {
      const jobsGrid = document.getElementById('jobsGrid');
      jobsGrid.innerHTML = '<p style="text-align: center; padding: 40px;">Loading jobs...</p>';

      try {
        const jobsSnap = await getDocs(collection(db, 'jobs'));
        if (jobsSnap.empty) {
          jobsGrid.innerHTML = '<p style="text-align: center; padding: 40px;">No job posts found.</p>';
          return;
        }

        const jobsHtml = [];
        jobsSnap.forEach(docSnap => {
          const job = docSnap.data();
          jobsHtml.push(`
            <div class="job-card">
              <div class="job-header">
                <h3>${job.title || ''}</h3>
                <span class="job-type ${(job.type || '').toLowerCase()}">${job.type || 'Full-time'}</span>
              </div>
              <div class="job-info">
                <p><i class="fas fa-building"></i> ${job.company || ''}</p>
                <p><i class="fas fa-map-marker-alt"></i> ${job.location || ''}</p>
              </div>
              <p class="job-description">${job.description || ''}</p>
              <div class="job-actions">
                <button class="edit-job-btn" data-id="${docSnap.id}"><i class="fas fa-edit"></i> Edit</button>
                <button class="delete-job-btn" data-id="${docSnap.id}"><i class="fas fa-trash"></i> Delete</button>
                <span class="post-date">Posted: ${job.postedDate ? new Date(job.postedDate.toDate()).toLocaleDateString() : ''}</span>
              </div>
            </div>
          `);
        });

        jobsGrid.innerHTML = jobsHtml.join('');

        document.querySelectorAll('.edit-job-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const jobId = btn.getAttribute('data-id');
            const jobDoc = await getDoc(doc(db, 'jobs', jobId));
            if (jobDoc.exists()) {
              const jobData = jobDoc.data();
              const newTitle = prompt('Edit job title:', jobData.title);
              if (newTitle !== null) {
                await setDoc(doc(db, 'jobs', jobId), {
                  ...jobData,
                  title: newTitle,
                  updatedAt: new Date()
                });
                alert('Job updated!');
                loadJobs();
              }
            }
          });
        });

        document.querySelectorAll('.delete-job-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (confirm('Delete this job post?')) {
              await deleteDoc(doc(db, 'jobs', btn.getAttribute('data-id')));
              alert('Job deleted!');
              loadJobs();
            }
          });
        });
      } catch (error) {
        console.error('Error loading jobs:', error);
        jobsGrid.innerHTML = '<p style="color: red;">Error loading jobs.</p>';
      }
    }

    // Create Job
    document.getElementById('createJobBtn')?.addEventListener('click', async () => {
      const title = prompt('Job Title:');
      if (!title) return;
      
      const company = prompt('Company:');
      const location = prompt('Location:');
      const type = prompt('Type (Full-time/Internship/Part-time):');
      const description = prompt('Description:');

      try {
        await addDoc(collection(db, 'jobs'), {
          title,
          company,
          location,
          type,
          description,
          postedDate: serverTimestamp(),
          postedBy: currentUser.uid
        });
        alert('Job posted successfully!');
        loadJobs();
      } catch (error) {
        console.error('Error creating job:', error);
        alert('Failed to create job post.');
      }
    });

    // Load Events
    async function loadEvents() {
      const eventsGrid = document.getElementById('eventsGrid');
      eventsGrid.innerHTML = '<p style="text-align: center; padding: 40px;">Loading events...</p>';

      try {
        const eventsSnap = await getDocs(collection(db, 'events'));
        if (eventsSnap.empty) {
          eventsGrid.innerHTML = '<p style="text-align: center; padding: 40px;">No events found.</p>';
          return;
        }

        const eventsHtml = [];
        eventsSnap.forEach(docSnap => {
          const event = docSnap.data();
          eventsHtml.push(`
            <div class="event-card">
              <h3>${event.title || ''}</h3>
              <div class="event-info">
                <p><i class="fas fa-calendar"></i> ${event.date || ''}</p>
                <p><i class="fas fa-clock"></i> ${event.time || ''}</p>
                <p><i class="fas fa-map-marker-alt"></i> ${event.location || ''}</p>
              </div>
              <p>${event.description || ''}</p>
              <button class="register-btn" onclick="alert('Registration feature coming soon!')">
                <i class="fas fa-check-circle"></i> Register for Event
              </button>
            </div>
          `);
        });

        eventsGrid.innerHTML = eventsHtml.join('');
      } catch (error) {
        console.error('Error loading events:', error);
        eventsGrid.innerHTML = '<p style="color: red;">Error loading events.</p>';
      }
    }

    // Initialize
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        await loadAlumniProfile(user.uid);
        await loadRequests();
        await loadConversations();
      } else {
        window.location.href = 'index.html';
      }
    });
  </script>

  <!-- Mobile Menu Toggle Script -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Create hamburger menu button
      const menuToggle = document.createElement('button');
      menuToggle.className = 'menu-toggle';
      menuToggle.innerHTML = '<i class="fas fa-bars"></i>';
      menuToggle.setAttribute('aria-label', 'Toggle menu');
      
      // Create overlay
      const overlay = document.createElement('div');
      overlay.className = 'sidebar-overlay';
      
      // Insert elements into DOM
      document.body.insertBefore(menuToggle, document.body.firstChild);
      document.body.insertBefore(overlay, document.body.firstChild);
      
      const sidebar = document.querySelector('.sidebar');
      
      // Toggle menu function
      function toggleMenu() {
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
        
        // Change icon
        const icon = menuToggle.querySelector('i');
        if (sidebar.classList.contains('active')) {
          icon.className = 'fas fa-times';
        } else {
          icon.className = 'fas fa-bars';
        }
      }
      
      // Event listeners
      menuToggle.addEventListener('click', toggleMenu);
      overlay.addEventListener('click', toggleMenu);
      
      // Close menu when clicking on a nav item (mobile only)
      const navLinks = document.querySelectorAll('.nav-links li');
      navLinks.forEach(link => {
        link.addEventListener('click', function() {
          if (window.innerWidth <= 768) {
            toggleMenu();
          }
        });
      });
      
      // Close menu on window resize if screen becomes larger
      window.addEventListener('resize', function() {
        if (window.innerWidth > 768) {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
          menuToggle.querySelector('i').className = 'fas fa-bars';
        }
      });
      
      // Prevent body scroll when menu is open
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.attributeName === 'class') {
            if (sidebar.classList.contains('active')) {
              document.body.style.overflow = 'hidden';
            } else {
              document.body.style.overflow = '';
            }
          }
        });
      });
      
      observer.observe(sidebar, { attributes: true });
    });
  </script>
</body>
</html>