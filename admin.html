<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

    * {
      margin: 12;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    :root {
      --primary: #5E35B1;
      --primary-hover: #4527A0;
      --secondary: #7C4DFF;
      --success: #00C853;
      --danger: #D50000;
      --warning: #FFD600;
      --background: #F5F5F7;
      --surface: #FFFFFF;
      --text-primary: #1D1D1F;
      --text-secondary: #6E6E73;
      --border: #D2D2D7;
      --radius: 18px;
      --radius-sm: 12px;
    }

    body {
      background: var(--background);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
    }

    .dashboard-body {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 280px;
      background: linear-gradient(180deg, #5E35B1 0%, #7C4DFF 100%);
      height: 100vh;
      padding: 32px 0;
      position: sticky;
      top: 0;
      display: flex;
      flex-direction: column;
      box-shadow: 4px 0 20px rgba(94, 53, 177, 0.2);
    }

    .sidebar-header {
      padding: 0 24px 32px;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 24px;
    }

    .avatar {
      width: 80px;
      height: 80px;
      border-radius: var(--radius);
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: 700;
      margin: 0 auto 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .sidebar-header h3 {
      font-size: 17px;
      font-weight: 600;
      color: white;
    }

    .nav-links {
      list-style: none;
      padding: 0 16px;
      flex: 1;
    }

    .nav-links li {
      padding: 12px 16px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      cursor: pointer;
      color: rgba(255, 255, 255, 0.8);
      border-radius: var(--radius-sm);
      font-weight: 500;
      font-size: 15px;
      transition: all 0.3s ease;
    }

    .nav-links li:hover {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      transform: translateX(4px);
    }

    .nav-links li.active {
      background: rgba(255, 255, 255, 0.25);
      color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
    }

    .nav-links li i {
      margin-right: 12px;
      width: 20px;
      font-size: 18px;
    }

    .main-content {
      flex: 1;
      padding: 48px;
      overflow-y: auto;
      height: 100vh;
    }

    .content-section {
      display: none;
      animation: fadeIn 0.4s ease;
      max-width: 1400px;
      margin: 0 auto;
    }

    .content-section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .content-section h2 {
      font-size: 34px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 32px;
      letter-spacing: -0.5px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 28px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, var(--primary), var(--secondary));
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    .stat-icon {
      width: 56px;
      height: 56px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 16px;
    }

    .stat-icon.primary {
      background: rgba(94, 53, 177, 0.1);
      color: var(--primary);
    }

    .stat-icon.success {
      background: rgba(0, 200, 83, 0.1);
      color: var(--success);
    }

    .stat-icon.warning {
      background: rgba(255, 214, 0, 0.1);
      color: var(--warning);
    }

    .stat-icon.danger {
      background: rgba(213, 0, 0, 0.1);
      color: var(--danger);
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .search-box {
      background: var(--surface);
      padding: 20px 24px;
      border-radius: var(--radius);
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
      align-items: center;
    }

    .search-box input {
      flex: 1;
      padding: 12px 20px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 15px;
      background: var(--background);
    }

    .search-box button, .add-user-btn {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(94, 53, 177, 0.3);
    }

    .search-box button:hover, .add-user-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(94, 53, 177, 0.4);
    }

    .users-table-container {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .users-table {
      width: 100%;
      border-collapse: collapse;
    }

    .users-table thead {
      background: var(--background);
    }

    .users-table th {
      padding: 20px 24px;
      text-align: left;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .users-table td {
      padding: 20px 24px;
      border-top: 1px solid var(--border);
    }

    .users-table tbody tr {
      transition: all 0.3s ease;
    }

    .users-table tbody tr:hover {
      background: var(--background);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600;
    }

    .user-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .role-badge {
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .role-badge.student {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
    }

    .role-badge.alumni {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-badge.active {
      background: rgba(0, 200, 83, 0.1);
      color: var(--success);
    }

    .status-badge.pending {
      background: rgba(255, 214, 0, 0.1);
      color: var(--warning);
    }

    .status-badge.blocked {
      background: rgba(213, 0, 0, 0.1);
      color: var(--danger);
    }

    .user-actions {
      display: flex;
      gap: 8px;
    }

    .user-actions button {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    .edit-btn {
      background: rgba(0, 122, 255, 0.1);
      color: #007AFF;
    }

    .delete-btn {
      background: rgba(213, 0, 0, 0.1);
      color: var(--danger);
    }

    .block-btn {
      background: rgba(110, 110, 115, 0.1);
      color: var(--text-secondary);
    }

    .user-actions button:hover {
      transform: translateY(-2px);
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
    }

    .settings-card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 32px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
    }

    .settings-card h3 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 24px;
      color: var(--text-primary);
    }

    .settings-group {
      margin-bottom: 24px;
    }

    .settings-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .settings-group input,
    .settings-group select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 15px;
      background: var(--background);
      transition: all 0.3s ease;
    }

    .settings-group input:focus,
    .settings-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(94, 53, 177, 0.1);
    }

    .save-settings {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(94, 53, 177, 0.3);
      width: 100%;
      margin-top: 8px;
    }

    .save-settings:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(94, 53, 177, 0.4);
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--background);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    /* Events Section */
    .events-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 24px;
      margin-top: 24px;
    }

    .event-card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    .event-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    .event-card h3 {
      font-size: 18px;
      margin-bottom: 12px;
      color: var(--text-primary);
    }

    .event-info {
      margin: 12px 0;
    }

    .event-info p {
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .event-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }

    .edit-event-btn, .delete-event-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .edit-event-btn {
      background: rgba(0, 122, 255, 0.1);
      color: #007AFF;
    }

    .delete-event-btn {
      background: rgba(213, 0, 0, 0.1);
      color: var(--danger);
    }

    .create-event-btn {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(94, 53, 177, 0.3);
    }

    .create-event-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(94, 53, 177, 0.4);
    }
  </style>
</head>
<body class="dashboard-body">
  <nav class="sidebar">
    <div class="sidebar-header">
      <div class="avatar">
        <i class="fas fa-shield-alt"></i>
      </div>
      <h3>Admin Panel</h3>
    </div>
    <ul class="nav-links">
      <li class="active" data-page="dashboard">
        <i class="fas fa-th-large"></i>
        <span>Dashboard</span>
      </li>
      <li data-page="users">
        <i class="fas fa-users"></i>
        <span>Manage Users</span>
      </li>
      <li data-page="events">
        <i class="fas fa-calendar"></i>
        <span>Manage Events</span>
      </li>
      <li data-page="settings">
        <i class="fas fa-cog"></i>
        <span>Settings</span>
      </li>
      <li id="adminLogoutBtn">
        <i class="fas fa-sign-out-alt"></i>
        <span>Logout</span>
      </li>
    </ul>
  </nav>

  <main class="main-content">
    <section id="dashboard" class="content-section active">
      <h2>Dashboard Overview</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon primary">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-value" id="totalUsers">0</div>
          <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon success">
            <i class="fas fa-user-graduate"></i>
          </div>
          <div class="stat-value" id="totalStudents">0</div>
          <div class="stat-label">Students</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon warning">
            <i class="fas fa-user-tie"></i>
          </div>
          <div class="stat-value" id="totalAlumni">0</div>
          <div class="stat-label">Alumni</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon danger">
            <i class="fas fa-calendar"></i>
          </div>
          <div class="stat-value" id="totalEvents">0</div>
          <div class="stat-label">Events</div>
        </div>
      </div>
    </section>

    <section id="users" class="content-section">
      <h2>Manage Users</h2>
      <div class="search-box">
        <input type="text" id="searchUsers" placeholder="Search users by name or email...">
        <button id="searchBtn"><i class="fas fa-search"></i> Search</button>
        <button class="add-user-btn" id="addUserBtn"><i class="fas fa-plus"></i> Add User</button>
      </div>
      <div class="users-table-container">
        <table class="users-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Joined</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <tr>
              <td colspan="6" style="text-align: center; padding: 40px;">Loading users...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section id="events" class="content-section">
      <h2>Manage Events</h2>
      <button class="create-event-btn" id="createEventBtn">
        <i class="fas fa-plus"></i> Create New Event
      </button>
      <div class="events-grid" id="eventsGrid">
        <p style="text-align: center; padding: 40px;">Loading events...</p>
      </div>
    </section>

    <section id="settings" class="content-section">
      <h2>Settings</h2>
      <div class="settings-grid">
        <div class="settings-card">
          <h3>General Settings</h3>
          <div class="settings-group">
            <label>Platform Name</label>
            <input type="text" id="platformName" value="Alumni Connection">
          </div>
          <div class="settings-group">
            <label>Admin Email</label>
            <input type="email" id="adminEmail" value="admin@alumni.edu">
          </div>
          <div class="settings-group">
            <label>User Registration</label>
            <select id="registrationSetting">
              <option value="open">Open Registration</option>
              <option value="invite">Invite Only</option>
              <option value="closed">Closed</option>
            </select>
          </div>
          <button class="save-settings">
            <i class="fas fa-save"></i> Save Settings
          </button>
        </div>

        <div class="settings-card">
          <h3>Email Settings</h3>
          <div class="settings-group">
            <label>SMTP Server</label>
            <input type="text" id="smtpServer" value="smtp.alumni.edu">
          </div>
          <div class="settings-group">
            <label>SMTP Port</label>
            <input type="number" id="smtpPort" value="587">
          </div>
          <div class="settings-group">
            <label>Email Template</label>
            <select id="emailTemplate">
              <option value="default">Default Template</option>
              <option value="minimal">Minimal Template</option>
              <option value="modern">Modern Template</option>
            </select>
          </div>
          <button class="save-settings">
            <i class="fas fa-save"></i> Save Settings
          </button>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, getDoc, setDoc, deleteDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhdtT0VMBmz8-vsVVa9KlcycSHnvtyxE4",
      authDomain: "alumni-connection-007.firebaseapp.com",
      projectId: "alumni-connection-007",
      storageBucket: "alumni-connection-007.appspot.com",
      messagingSenderId: "210833800961",
      appId: "1:210833800961:web:cb46b2ef133bd0d48a6500",
      measurementId: "G-MJQ8BJ5520"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const getInitials = (name) => name?.split(' ').map(w => w[0]).join('').toUpperCase() || 'U';

    // Navigation
    document.querySelectorAll('.nav-links li[data-page]').forEach(item => {
      item.addEventListener('click', function() {
        document.querySelectorAll('.nav-links li').forEach(i => i.classList.remove('active'));
        this.classList.add('active');
        
        document.querySelectorAll('.content-section').forEach(section => {
          section.classList.remove('active');
        });
        
        const pageId = this.getAttribute('data-page');
        const targetSection = document.getElementById(pageId);
        
        if (targetSection) {
          targetSection.classList.add('active');
          
          if (pageId === 'users') {
            loadUsers();
          } else if (pageId === 'dashboard') {
            loadStatistics();
          } else if (pageId === 'events') {
            loadEvents();
          }
        }
      });
    });

    document.getElementById("adminLogoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });

    // Load Statistics
    const loadStatistics = async () => {
      try {
        const studentsSnap = await getDocs(collection(db, 'students'));
        const alumniSnap = await getDocs(collection(db, 'alumni'));
        const eventsSnap = await getDocs(collection(db, 'events'));

        document.getElementById('totalStudents').textContent = studentsSnap.size;
        document.getElementById('totalAlumni').textContent = alumniSnap.size;
        document.getElementById('totalUsers').textContent = studentsSnap.size + alumniSnap.size;
        document.getElementById('totalEvents').textContent = eventsSnap.size;
      } catch (error) {
        console.error('Error loading statistics:', error);
      }
    };

    // FIXED: Load Users - Properly distinguish between students and alumni
    const loadUsers = async () => {
      const usersTableBody = document.getElementById('usersTableBody');
      usersTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">Loading users...</td></tr>';

      try {
        const students = await getDocs(collection(db, 'students'));
        const alumni = await getDocs(collection(db, 'alumni'));

        const allUsers = [];
        
        // Add students with proper role and collection tracking
        students.forEach(docSnap => {
          allUsers.push({ 
            id: docSnap.id, 
            ...docSnap.data(), 
            role: 'Student',
            collectionName: 'students'
          });
        });
        
        // Add alumni with proper role and collection tracking
        alumni.forEach(docSnap => {
          allUsers.push({ 
            id: docSnap.id, 
            ...docSnap.data(), 
            role: 'Alumni',
            collectionName: 'alumni'
          });
        });

        if (allUsers.length === 0) {
          usersTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-secondary);">No users found</td></tr>';
          return;
        }

        usersTableBody.innerHTML = allUsers.map(user => `
          <tr>
            <td>
              <div class="user-info">
                <div class="user-avatar">${getInitials(user.name || 'User')}</div>
                <span class="user-name">${user.name || 'Unknown'}</span>
              </div>
            </td>
            <td>${user.email || ''}</td>
            <td><span class="role-badge ${user.role.toLowerCase()}">${user.role}</span></td>
            <td>
              <span class="status-badge ${(user.status || 'active').toLowerCase()}">
                ${(user.status || 'active').toUpperCase()}
              </span>
            </td>
            <td>${user.createdAt ? new Date(user.createdAt.toDate()).toLocaleDateString() : ''}</td>
            <td>
              <div class="user-actions">
                <button class="edit-btn" data-id="${user.id}" data-collection="${user.collectionName}" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="block-btn" data-id="${user.id}" data-collection="${user.collectionName}" title="Block">
                  <i class="fas fa-ban"></i>
                </button>
                <button class="delete-btn" data-id="${user.id}" data-collection="${user.collectionName}" title="Delete">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');

        // Edit functionality
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const userId = btn.getAttribute('data-id');
            const collectionName = btn.getAttribute('data-collection');
            
            try {
              const userDoc = await getDoc(doc(db, collectionName, userId));
              if (!userDoc.exists()) {
                alert('User not found');
                return;
              }
              
              const userData = userDoc.data();
              const newName = prompt('Enter new name:', userData.name);
              if (newName !== null && newName.trim()) {
                await setDoc(doc(db, collectionName, userId), {
                  ...userData,
                  name: newName,
                  updatedAt: new Date()
                });
                alert('User updated successfully');
                loadUsers();
                loadStatistics();
              }
            } catch (error) {
              console.error('Error editing user:', error);
              alert('Failed to edit user: ' + error.message);
            }
          });
        });

        // Block functionality
        document.querySelectorAll('.block-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const userId = btn.getAttribute('data-id');
            const collectionName = btn.getAttribute('data-collection');
            
            try {
              const userDoc = await getDoc(doc(db, collectionName, userId));
              if (!userDoc.exists()) {
                alert('User not found');
                return;
              }
              
              const userData = userDoc.data();
              const currentStatus = userData.status || 'active';
              const newStatus = currentStatus === 'active' ? 'blocked' : 'active';
              
              await setDoc(doc(db, collectionName, userId), {
                ...userData,
                status: newStatus,
                updatedAt: new Date()
              });
              
              alert(`User ${newStatus === 'blocked' ? 'blocked' : 'unblocked'} successfully`);
              loadUsers();
            } catch (error) {
              console.error('Error updating user status:', error);
              alert('Failed to update user status: ' + error.message);
            }
          });
        });

        // Delete functionality
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (confirm('Delete this user? This action cannot be undone.')) {
              const userId = btn.getAttribute('data-id');
              const collectionName = btn.getAttribute('data-collection');
              
              try {
                await deleteDoc(doc(db, collectionName, userId));
                alert('User deleted successfully');
                loadUsers();
                loadStatistics();
              } catch (error) {
                console.error('Error deleting user:', error);
                alert('Failed to delete user: ' + error.message);
              }
            }
          });
        });
      } catch (error) {
        console.error('Error loading users:', error);
        usersTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">Error loading users</td></tr>';
      }
    };

    // Add User
    document.getElementById('addUserBtn').addEventListener('click', async () => {
      const role = prompt('Enter user role (Student/Alumni):', 'Student');
      if (!role || !['Student', 'Alumni'].includes(role)) {
        alert('Invalid role specified');
        return;
      }

      const name = prompt('Enter user name:');
      if (!name) return;

      const email = prompt('Enter user email:');
      if (!email) return;

      const collectionName = role.toLowerCase() + 's';
      const userId = 'manual_' + Date.now();

      try {
        await setDoc(doc(db, collectionName, userId), {
          name: name,
          email: email,
          status: 'active',
          role: role,
          createdAt: new Date(),
          updatedAt: new Date()
        });

        alert('User added successfully');
        loadUsers();
        loadStatistics();
      } catch (error) {
        console.error('Error adding user:', error);
        alert('Failed to add user: ' + error.message);
      }
    });

    // EVENTS MANAGEMENT - Admin Only
    const loadEvents = async () => {
      const eventsGrid = document.getElementById('eventsGrid');
      eventsGrid.innerHTML = '<p style="text-align: center; padding: 40px;">Loading events...</p>';

      try {
        const eventsSnap = await getDocs(collection(db, 'events'));
        
        if (eventsSnap.empty) {
          eventsGrid.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-secondary);">No events found. Create your first event!</p>';
          return;
        }

        const eventsHtml = [];
        eventsSnap.forEach(docSnap => {
          const event = docSnap.data();
          eventsHtml.push(`
            <div class="event-card">
              <h3>${event.title || 'Untitled Event'}</h3>
              <div class="event-info">
                <p><i class="fas fa-calendar"></i> ${event.date || 'Date not set'}</p>
                <p><i class="fas fa-clock"></i> ${event.time || 'Time not set'}</p>
                <p><i class="fas fa-map-marker-alt"></i> ${event.location || 'Location not set'}</p>
              </div>
              <p style="color: var(--text-secondary); margin-top: 12px;">${event.description || 'No description'}</p>
              <div class="event-actions">
                <button class="edit-event-btn" data-id="${docSnap.id}">
                  <i class="fas fa-edit"></i> Edit
                </button>
                <button class="delete-event-btn" data-id="${docSnap.id}">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>
            </div>
          `);
        });

        eventsGrid.innerHTML = eventsHtml.join('');

        // Edit event
        document.querySelectorAll('.edit-event-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const eventId = btn.getAttribute('data-id');
            try {
              const eventDoc = await getDoc(doc(db, 'events', eventId));
              if (!eventDoc.exists()) {
                alert('Event not found');
                return;
              }
              
              const eventData = eventDoc.data();
              const newTitle = prompt('Edit event title:', eventData.title);
              const newDate = prompt('Edit event date (e.g., March 15, 2026):', eventData.date);
              const newTime = prompt('Edit event time:', eventData.time);
              const newLocation = prompt('Edit event location:', eventData.location);
              const newDescription = prompt('Edit event description:', eventData.description);
              
              // Validate date if provided
              if (newDate !== null && newDate.trim() !== '') {
                const parsed = new Date(newDate);
                if (isNaN(parsed.getTime())) {
                  alert('Invalid date format. Please use a recognizable future date (e.g., March 15, 2026).');
                  return;
                }
                const now = new Date();
                // Compare only date/time; reject past
                if (parsed < now) {
                  alert('Not applicable: the provided event date is in the past. Please enter a future event date.');
                  return;
                }
              }

              if (newTitle !== null) {
                await setDoc(doc(db, 'events', eventId), {
                  title: newTitle || eventData.title,
                  date: newDate || eventData.date,
                  time: newTime || eventData.time,
                  location: newLocation || eventData.location,
                  description: newDescription || eventData.description,
                  updatedAt: new Date()
                });
                alert('Event updated successfully');
                loadEvents();
                loadStatistics();
              }
            } catch (error) {
              console.error('Error editing event:', error);
              alert('Failed to edit event: ' + error.message);
            }
          });
        });

        // Delete event
        document.querySelectorAll('.delete-event-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (confirm('Delete this event? This action cannot be undone.')) {
              const eventId = btn.getAttribute('data-id');
              try {
                await deleteDoc(doc(db, 'events', eventId));
                alert('Event deleted successfully');
                loadEvents();
                loadStatistics();
              } catch (error) {
                console.error('Error deleting event:', error);
                alert('Failed to delete event: ' + error.message);
              }
            }
          });
        });
      } catch (error) {
        console.error('Error loading events:', error);
        eventsGrid.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--danger);">Error loading events</p>';
      }
    };

    // Create Event
    document.getElementById('createEventBtn').addEventListener('click', async () => {
      const title = prompt('Event Title:');
      if (!title) return;
      
      const date = prompt('Event Date (e.g., March 15, 2026):');
      if (!date) return;
      // Validate date
      const parsedDate = new Date(date);
      if (isNaN(parsedDate.getTime())) {
        alert('Invalid date format. Please enter a recognizable future date (e.g., March 15, 2026).');
        return;
      }
      const now = new Date();
      if (parsedDate < now) {
        alert('Not applicable: the provided event date is in the past. Please enter a future event date.');
        return;
      }
      
      const time = prompt('Event Time (e.g., 10:00 AM - 2:00 PM):');
      if (!time) return;
      
      const location = prompt('Event Location:');
      if (!location) return;
      
      const description = prompt('Event Description:');
      if (!description) return;

      try {
        await addDoc(collection(db, 'events'), {
          title,
          date,
          time,
          location,
          description,
          createdAt: serverTimestamp(),
          createdBy: auth.currentUser.uid
        });
        
        alert('Event created successfully!');
        loadEvents();
        loadStatistics();
      } catch (error) {
        console.error('Error creating event:', error);
        alert('Failed to create event: ' + error.message);
      }
    });

    // Initialize
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          // Check if user is admin
          const adminDoc = await getDoc(doc(db, 'admins', user.uid));
          if (!adminDoc.exists()) {
            alert('Access denied. Admin privileges required.');
            await signOut(auth);
            window.location.href = "index.html";
            return;
          }

          // Initialize admin dashboard
          await Promise.all([
            loadStatistics(),
            loadUsers()
          ]);
        } catch (error) {
          console.error('Error initializing admin dashboard:', error);
          alert('Error loading admin dashboard: ' + error.message);
        }
      } else {
        window.location.href = "index.html";
      }
    });
  </script>

  <!-- Mobile Menu Toggle Script -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Create hamburger menu button
      const menuToggle = document.createElement('button');
      menuToggle.className = 'menu-toggle';
      menuToggle.innerHTML = '<i class="fas fa-bars"></i>';
      menuToggle.setAttribute('aria-label', 'Toggle menu');
      
      // Create overlay
      const overlay = document.createElement('div');
      overlay.className = 'sidebar-overlay';
      
      // Insert elements into DOM
      document.body.insertBefore(menuToggle, document.body.firstChild);
      document.body.insertBefore(overlay, document.body.firstChild);
      
      const sidebar = document.querySelector('.sidebar');
      
      // Toggle menu function
      function toggleMenu() {
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
        
        // Change icon
        const icon = menuToggle.querySelector('i');
        if (sidebar.classList.contains('active')) {
          icon.className = 'fas fa-times';
        } else {
          icon.className = 'fas fa-bars';
        }
      }
      
      // Event listeners
      menuToggle.addEventListener('click', toggleMenu);
      overlay.addEventListener('click', toggleMenu);
      
      // Close menu when clicking on a nav item (mobile only)
      const navLinks = document.querySelectorAll('.nav-links li');
      navLinks.forEach(link => {
        link.addEventListener('click', function() {
          if (window.innerWidth <= 768) {
            toggleMenu();
          }
        });
      });
      
      // Close menu on window resize if screen becomes larger
      window.addEventListener('resize', function() {
        if (window.innerWidth > 768) {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
          menuToggle.querySelector('i').className = 'fas fa-bars';
        }
      });
      
      // Prevent body scroll when menu is open
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.attributeName === 'class') {
            if (sidebar.classList.contains('active')) {
              document.body.style.overflow = 'hidden';
            } else {
              document.body.style.overflow = '';
            }
          }
        });
      });
      
      observer.observe(sidebar, { attributes: true });
    });
  </script>
</body>
</html>
